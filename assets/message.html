<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Form Responses</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" />    
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="index.css">
    <style>
      #myBtn{
        color: #0766AD;
        border:none;
        text-align: center;
      }
    </style>
</head>
<body>

  <div class="chat-messages">
    <div class="message incoming">
    </div>
  </div>


  <script src="encode_decode.js"></script>
  <script>
    const chatMessages = document.querySelector('.chat-messages');
    var sender_name='unknown';
    setInterval(loadMessages, 1000);
    function loadMessages(){
      const url = 'https://script.google.com/macros/s/AKfycbzIvqu9R-E20uqLHUPqrmEbhLlHnfkntIjkjx5mOB2aoSQWnjezRVuEyTAzN2Ch86C-UQ/exec';
      const formUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
      fetch(formUrl)
    .then(response => response.text())
    .then(text => {
      return JSON.parse(text);
    })
    .then(data_lst => {
      for(let i=chatMessages.querySelectorAll('.incoming').length-1;i<data_lst.length;i++){
        var incomingCount = chatMessages.querySelectorAll('.incoming').length;
        data = getDecode(data_lst[i].message);
        if(data.includes(":")){
          var arr = data.split(':', 2)
          sender_name = arr[0];
          messageText=arr[1];
          if(incomingCount<data_lst.length+1){
            myFunction(messageText);
          }
        }else{
          messageText=data;
          if(incomingCount<data_lst.length+1){
            myFunction(messageText);
          }
        }
      }
    }).catch(error => console.error('Error fetching form responses:', error)); 
  }
    function myFunction(messageText) {
      const response1 = document.createElement('div');
      response1.classList.add('message', 'incoming');
      response1.innerHTML = `<div class="avatar"></div>
      <div class="text"><input class="cpylabel" type="text" value="${sender_name}" readonly><button class="btn" id="cpybtn" onclick="copytext()"><i class="fa fa-clipboard" style="vertical-align: top;"></i></button><div id="res_msg">${messageText}<textarea id="cpytxt">${messageText}</textarea></div></div>
      `;
      chatMessages.appendChild(response1);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      copytext();
      
  }

  function copytext(){
    if (document.querySelector('.btn')) {
      // select all buttons, each as el
      document.querySelectorAll('.btn').forEach(function(el) {
        // bind click event to each el
        el.addEventListener('click', function (e) {
          // check also if there is at least on .childelement
          // e.target is the clicked element, parentNode the parent, from there find .childElement
          if (e.target.parentNode.querySelector('.incoming')) {
            e.target.parentNode.querySelector('.incoming').classList.add('Example');
          }
          else {
           var x = e.target.parentNode.innerText;
           $("textarea").css("display","block");
           $("textarea").text(x);
            $("textarea").select();
            document.execCommand("copy");
            $("textarea").css("display","none");
          }
          
        });
    
       });
      }
  }

  </script>

</body>
</html>
